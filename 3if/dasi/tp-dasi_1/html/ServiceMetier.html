<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>ServiceMetier.java</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<style type="text/css">
<!--
body {color: #000000; background-color: #ffffff; font-family: Monospaced}
pre {color: #000000; background-color: #ffffff; font-family: Monospaced}
table {color: #000000; background-color: #e9e8e2; font-family: Monospaced}
.ST0 {font-family: Monospaced; font-style: italic}
.ST1 {font-family: Monospaced; font-weight: bold}
.comment {color: #969696}
.ST4 {color: #009900}
.ST3 {color: #ce7b00; font-family: Monospaced; font-weight: bold}
.character {color: #ce7b00}
.ST2 {color: #009900; font-family: Monospaced; font-style: italic}
.keyword-directive {color: #0000e6}
-->
</style>
</head>
<body>
<table width="100%"><tr><td align="center">L:\Documents\insa-private\3if\dasi\tp-dasi_1\src\main\java\fr\insalyon\gustatif\metier\service\ServiceMetier.java</td></tr></table>
<pre>
  1 <span class="keyword-directive">package</span> fr.insalyon.gustatif.metier.service;
  2 
  3 <span class="keyword-directive">import</span> com.google.maps.model.LatLng;
  4 <span class="keyword-directive">import</span> fr.insalyon.gustatif.dao.ClientDao;
  5 <span class="keyword-directive">import</span> fr.insalyon.gustatif.dao.CyclisteDao;
  6 <span class="keyword-directive">import</span> fr.insalyon.gustatif.dao.GestionnaireDao;
  7 <span class="keyword-directive">import</span> fr.insalyon.gustatif.dao.JpaUtil;
  8 <span class="keyword-directive">import</span> fr.insalyon.gustatif.dao.LivraisonDao;
  9 <span class="keyword-directive">import</span> fr.insalyon.gustatif.dao.LivreurDao;
 10 <span class="keyword-directive">import</span> fr.insalyon.gustatif.dao.ProduitDao;
 11 <span class="keyword-directive">import</span> fr.insalyon.gustatif.dao.RestaurantDao;
 12 <span class="keyword-directive">import</span> fr.insalyon.gustatif.metier.modele.Client;
 13 <span class="keyword-directive">import</span> fr.insalyon.gustatif.metier.modele.Cycliste;
 14 <span class="keyword-directive">import</span> fr.insalyon.gustatif.metier.modele.Drone;
 15 <span class="keyword-directive">import</span> fr.insalyon.gustatif.metier.modele.Gestionnaire;
 16 <span class="keyword-directive">import</span> fr.insalyon.gustatif.metier.modele.Livraison;
 17 <span class="keyword-directive">import</span> fr.insalyon.gustatif.metier.modele.Livreur;
 18 <span class="keyword-directive">import</span> fr.insalyon.gustatif.metier.modele.Produit;
 19 <span class="keyword-directive">import</span> fr.insalyon.gustatif.metier.modele.Restaurant;
 20 <span class="keyword-directive">import</span> java.util.Date;
 21 <span class="keyword-directive">import</span> java.util.HashMap;
 22 <span class="keyword-directive">import</span> java.util.List;
 23 <span class="keyword-directive">import</span> java.util.Map.<span class="ST0">Entry</span>;
 24 <span class="keyword-directive">import</span> java.util.Random;
 25 
 26 <span class="keyword-directive">public</span> <span class="keyword-directive">class</span> <span class="ST1">ServiceMetier</span> {
 27 
 28     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> ClientDao <span class="ST2">CLIENT_DAO</span> = <span class="keyword-directive">new</span> ClientDao();
 29     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> CyclisteDao <span class="ST2">CYCLISTE_DAO</span> = <span class="keyword-directive">new</span> CyclisteDao();
 30     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> GestionnaireDao <span class="ST2">GESTIONNAIRE_DAO</span> = <span class="keyword-directive">new</span> GestionnaireDao();
 31     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> LivraisonDao <span class="ST2">LIVRAISON_DAO</span> = <span class="keyword-directive">new</span> LivraisonDao();
 32     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> LivreurDao <span class="ST2">LIVREUR_DAO</span> = <span class="keyword-directive">new</span> LivreurDao();
 33     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> ProduitDao <span class="ST2">PRODUIT_DAO</span> = <span class="keyword-directive">new</span> ProduitDao();
 34     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> RestaurantDao <span class="ST2">RESTAURANT_DAO</span> = <span class="keyword-directive">new</span> RestaurantDao();
 35 
 36     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> String[] <span class="ST2">NOMS</span> = {
 37         <span class="character">&quot;</span><span class="character">MARTIN</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">DUPRE</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">BERNARD</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">DUBOIS</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">THOMAS</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">ROBERT</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">RICHARD</span><span class="character">&quot;</span>,
 38         <span class="character">&quot;</span><span class="character">PETIT</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">DURAND</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">LEROY</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">MOREAU</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">SIMON</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">LAURENT</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">LEFEBVRE</span><span class="character">&quot;</span>,
 39         <span class="character">&quot;</span><span class="character">MICHEL</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">GARCIA</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">DAVID</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">BERTRAND</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">ROUX</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">VINCENT</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">FOURNIER</span><span class="character">&quot;</span>,
 40         <span class="character">&quot;</span><span class="character">MOREL</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">GIRARD</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">ANDRE</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">LEFEVRE</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">MERCIER</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">DUPONT</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">LAMBERT</span><span class="character">&quot;</span>,
 41         <span class="character">&quot;</span><span class="character">BONNET</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">FRANCOIS</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">MARTINEZ</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">LEGRAND</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">GARNIER</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">FAURE</span><span class="character">&quot;</span>,
 42         <span class="character">&quot;</span><span class="character">ROUSSEAU</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">BLANC</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">GUERIN</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">MULLER</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">HENRY</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">ROUSSEL</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">NICOLAS</span><span class="character">&quot;</span>
 43     };
 44     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> String[] <span class="ST2">PRENOMS</span> = {
 45         <span class="character">&quot;</span><span class="character">Jean</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Daniel</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Anne</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Marie</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Pierre</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Jullie</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Marc</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Arnaud</span><span class="character">&quot;</span>,
 46         <span class="character">&quot;</span><span class="character">Lucas</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Nathan</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Enzo</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Leo</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Gabriel</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Louis</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Hugo</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Raphael</span><span class="character">&quot;</span>,
 47         <span class="character">&quot;</span><span class="character">Jules</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Arthur</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Ethan</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Timeo</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Chloe</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Emma</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Sarah</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Lena</span><span class="character">&quot;</span>,
 48         <span class="character">&quot;</span><span class="character">Jade</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Lola</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Ines</span><span class="character">&quot;</span>, <span class="character">&quot;</span><span class="character">Manon</span><span class="character">&quot;</span>
 49     };
 50     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> String[] <span class="ST2">RUES</span> = {
 51         <span class="character">&quot;</span><span class="character">Cours Emile Zola, 69100 Villeurbanne</span><span class="character">&quot;</span>,
 52         <span class="character">&quot;</span><span class="character">rue Galilée, 69100 Villeurbanne</span><span class="character">&quot;</span>,
 53         <span class="character">&quot;</span><span class="character">rue du Marais, 69100 Villeurbanne</span><span class="character">&quot;</span>,
 54         <span class="character">&quot;</span><span class="character">rue du Tonkin, 69100 Villeurbanne</span><span class="character">&quot;</span>
 55     };
 56     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> <span class="keyword-directive">int</span> <span class="ST2">MAX_NUMERO_RUE</span> = 100;
 57     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> <span class="keyword-directive">float</span> <span class="ST2">MAX_CAPACITE_CYCLISTE</span> = 50000.0f;
 58     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> <span class="keyword-directive">float</span> <span class="ST2">MAX_CAPACITE_DRONE</span> = 20000.0f;
 59     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> <span class="keyword-directive">float</span> <span class="ST2">MAX_VITESSE_MOYENNE</span> = 50.0f;
 60     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> <span class="keyword-directive">int</span> <span class="ST2">NUM_CYCLISTES</span> = 40;
 61     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> <span class="keyword-directive">int</span> <span class="ST2">NUM_DRONES</span> = 10;
 62     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> <span class="keyword-directive">int</span> <span class="ST2">NUM_GESTIONNAIRES</span> = 3;
 63 
 64     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> String <span class="ST2">FORMAT_MESSAGE_INSCRIPTION_SUCCES</span>
 65             = <span class="character">&quot;</span><span class="character">Bonjour %s,</span><span class="ST3">\n</span><span class="character">&quot;</span>
 66             + <span class="character">&quot;</span><span class="character">Nous vous confirmons votre inscription au service GUSTAT’IF. </span><span class="character">&quot;</span>
 67             + <span class="character">&quot;</span><span class="character">Votre numéro de client est : %d.</span><span class="character">&quot;</span>;
 68     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> String <span class="ST2">FORMAT_MESSAGE_INSCRIPTION_ECHEC</span>
 69             = <span class="character">&quot;</span><span class="character">Bonjour %s,</span><span class="ST3">\n</span><span class="character">&quot;</span>
 70             + <span class="character">&quot;</span><span class="character">Votre inscription au service GUSTAT’IF a malencontreusement échoué... </span><span class="character">&quot;</span>
 71             + <span class="character">&quot;</span><span class="character">Merci de recommencer ultérieurement.</span><span class="character">&quot;</span>;
 72     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> String <span class="ST2">FORMAT_MESSAGE_LIVREUR</span>
 73             = <span class="character">&quot;</span><span class="character">Bonjour %s,</span><span class="ST3">\n</span><span class="ST3">\n</span><span class="character">&quot;</span>
 74             + <span class="character">&quot;</span><span class="character">    Merci d&#39;effectuer cette livraison dès maintenant, tout en respectant le code de la route ;-)</span><span class="ST3">\n</span><span class="ST3">\n</span><span class="character">&quot;</span>
 75             + <span class="character">&quot;</span><span class="character">Le Chef</span><span class="ST3">\n</span><span class="ST3">\n</span><span class="character">&quot;</span>
 76             + <span class="character">&quot;</span><span class="character">Détails de la Livraison</span><span class="ST3">\n</span><span class="character">&quot;</span>
 77             + <span class="character">&quot;</span><span class="character">    - Date/heure : %s</span><span class="ST3">\n</span><span class="character">&quot;</span>
 78             + <span class="character">&quot;</span><span class="character">    - Livreur : %s %s (n°%d)</span><span class="ST3">\n</span><span class="character">&quot;</span>
 79             + <span class="character">&quot;</span><span class="character">    - Restaurant : %s</span><span class="ST3">\n</span><span class="character">&quot;</span>
 80             + <span class="character">&quot;</span><span class="character">    - Client : </span><span class="ST3">\n</span><span class="character">&quot;</span>
 81             + <span class="character">&quot;</span><span class="character">               %s %s</span><span class="ST3">\n</span><span class="character">&quot;</span>
 82             + <span class="character">&quot;</span><span class="character">               %s</span><span class="ST3">\n</span><span class="ST3">\n</span><span class="ST3">\n</span><span class="character">&quot;</span>
 83             + <span class="character">&quot;</span><span class="character">Commande : </span><span class="ST3">\n</span><span class="character">%s</span><span class="ST3">\n</span><span class="character">&quot;</span>
 84             + <span class="character">&quot;</span><span class="character">TOTAL : %.2f€</span><span class="character">&quot;</span>;
 85     <span class="keyword-directive">private</span> <span class="keyword-directive">static</span> <span class="keyword-directive">final</span> String <span class="ST2">FORMAT_PRODUIT</span> = <span class="character">&quot;</span><span class="character">    - %d %s : %d x %.2f€</span><span class="ST3">\n</span><span class="character">&quot;</span>;
 86 
 87     <span class="keyword-directive">public</span> <span class="keyword-directive">void</span> <span class="ST1">initialiserDonnees</span>() <span class="keyword-directive">throws</span> ServiceException {
 88         Random r = <span class="keyword-directive">new</span> Random();
 89         JpaUtil.<span class="ST0">creerEntityManager</span>();
 90         JpaUtil.<span class="ST0">ouvrirTransaction</span>();
 91 
 92         <span class="comment">// Création en dur des cyclistes</span>
 93         <span class="keyword-directive">for</span> (<span class="keyword-directive">int</span> i = 0; i &lt; <span class="ST2">NUM_CYCLISTES</span>; i++) {
 94             String nom = <span class="ST2">NOMS</span>[r.nextInt(<span class="ST2">NOMS</span>.<span class="ST4">length</span>)];
 95             String prenom = <span class="ST2">PRENOMS</span>[r.nextInt(<span class="ST2">PRENOMS</span>.<span class="ST4">length</span>)];
 96             String adresse = (r.nextInt(<span class="ST2">MAX_NUMERO_RUE</span>) + 1) + <span class="character">&quot;</span> <span class="character">&quot;</span> + <span class="ST2">RUES</span>[r.nextInt(<span class="ST2">RUES</span>.<span class="ST4">length</span>)];
 97             LatLng coordonnees = ServiceTechnique.<span class="ST0">getLatLng</span>(adresse);
 98             Cycliste cycliste = <span class="keyword-directive">new</span> Cycliste(
 99                     nom, prenom,
100                     prenom.toLowerCase() + <span class="character">&#39;</span><span class="character">.</span><span class="character">&#39;</span> + nom.toLowerCase() + <span class="character">&quot;</span><span class="character">@gustatif.fr</span><span class="character">&quot;</span>,
101                     <span class="character">&quot;</span><span class="character">password</span><span class="character">&quot;</span>,
102                     r.nextFloat() * <span class="ST2">MAX_CAPACITE_CYCLISTE</span>, <span class="keyword-directive">true</span>,
103                     (r.nextInt(<span class="ST2">MAX_NUMERO_RUE</span>) + 1) + <span class="character">&quot;</span> <span class="character">&quot;</span> + <span class="ST2">RUES</span>[r.nextInt(<span class="ST2">RUES</span>.<span class="ST4">length</span>)]
104             );
105             cycliste.setCoordonnees(coordonnees);
106             <span class="keyword-directive">try</span> {
107                 <span class="ST2">LIVREUR_DAO</span>.create(cycliste);
108             } <span class="keyword-directive">catch</span> (Throwable t) {
109                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
110                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_INITIALISATION</span>);
111             }
112         }
113 
114         <span class="comment">// Création en dur des drones</span>
115         <span class="keyword-directive">for</span> (<span class="keyword-directive">int</span> i = 0; i &lt; <span class="ST2">NUM_DRONES</span>; i++) {
116             Drone drone = <span class="keyword-directive">new</span> Drone(
117                     r.nextFloat() * <span class="ST2">MAX_VITESSE_MOYENNE</span>,
118                     r.nextFloat() * <span class="ST2">MAX_CAPACITE_DRONE</span>, <span class="keyword-directive">true</span>,
119                     (r.nextInt(<span class="ST2">MAX_NUMERO_RUE</span>) + 1) + <span class="character">&quot;</span> <span class="character">&quot;</span> + <span class="ST2">RUES</span>[r.nextInt(<span class="ST2">RUES</span>.<span class="ST4">length</span>)]
120             );
121             <span class="keyword-directive">try</span> {
122                 <span class="ST2">LIVREUR_DAO</span>.create(drone);
123             } <span class="keyword-directive">catch</span> (Throwable t) {
124                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
125                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_INITIALISATION</span>);
126             }
127         }
128 
129         <span class="comment">// Création en dur des gestionnaires</span>
130         <span class="keyword-directive">for</span> (<span class="keyword-directive">int</span> i = 0; i &lt; <span class="ST2">NUM_GESTIONNAIRES</span>; i++) {
131             String nom = <span class="ST2">NOMS</span>[r.nextInt(<span class="ST2">NOMS</span>.<span class="ST4">length</span>)];
132             String prenom = <span class="ST2">PRENOMS</span>[r.nextInt(<span class="ST2">PRENOMS</span>.<span class="ST4">length</span>)];
133             Gestionnaire gestionnaire = <span class="keyword-directive">new</span> Gestionnaire(
134                     prenom.toLowerCase() + <span class="character">&#39;</span><span class="character">.</span><span class="character">&#39;</span> + nom.toLowerCase() + <span class="character">&quot;</span><span class="character">@gustatif.fr</span><span class="character">&quot;</span>,
135                     <span class="character">&quot;</span><span class="character">password</span><span class="character">&quot;</span>
136             );
137             <span class="keyword-directive">try</span> {
138                 <span class="ST2">GESTIONNAIRE_DAO</span>.create(gestionnaire);
139             } <span class="keyword-directive">catch</span> (Throwable t) {
140                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
141                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_INITIALISATION</span>);
142             }
143         }
144 
145         JpaUtil.<span class="ST0">validerTransaction</span>();
146         JpaUtil.<span class="ST0">fermerEntityManager</span>();
147     }
148 
149     <span class="keyword-directive">public</span> <span class="keyword-directive">void</span> <span class="ST1">inscrireClient</span>(Client client) <span class="keyword-directive">throws</span> ServiceException {
150         <span class="comment">// Géolocaliser le client en cours d&#39;insccription.</span>
151         LatLng coordonnees = ServiceTechnique.<span class="ST0">getLatLng</span>(client.getAdresse());
152         client.setCoordonnees(coordonnees);
153 
154         JpaUtil.<span class="ST0">creerEntityManager</span>();
155         JpaUtil.<span class="ST0">ouvrirTransaction</span>();
156 
157         <span class="comment">// Vérifier qu&#39;il n&#39;y pas d&#39;autres clients avec le même mail</span>
158         <span class="keyword-directive">try</span> {
159             Client c = <span class="ST2">CLIENT_DAO</span>.findByMail(client.getMail());
160             JpaUtil.<span class="ST0">fermerEntityManager</span>();
161             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_CREATION_CLIENT_MAIL</span>);
162         } <span class="keyword-directive">catch</span> (Throwable t) {
163         }
164 
165         <span class="comment">// Ajouter le client.</span>
166         <span class="keyword-directive">try</span> {
167             <span class="ST2">CLIENT_DAO</span>.create(client);
168         } <span class="keyword-directive">catch</span> (Throwable t) {
169             ServiceTechnique.<span class="ST0">envoyerMail</span>(
170                     <span class="character">&quot;</span><span class="character">gustatif@gustatif.fr</span><span class="character">&quot;</span>, client.getMail(),
171                     <span class="character">&quot;</span><span class="character">Bienvenue chez GUSTAT&#39;IF</span><span class="character">&quot;</span>, String.<span class="ST0">format</span>(
172                             <span class="ST2">FORMAT_MESSAGE_INSCRIPTION_ECHEC</span>, client.getPrenom()
173                     )
174             );
175             JpaUtil.<span class="ST0">fermerEntityManager</span>();
176             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_CREATION_CLIENT</span>);
177         }
178         ServiceTechnique.<span class="ST0">envoyerMail</span>(
179                 <span class="character">&quot;</span><span class="character">gustatif@gustatif.fr</span><span class="character">&quot;</span>, client.getMail(),
180                 <span class="character">&quot;</span><span class="character">Bienvenue chez GUSTAT&#39;IF</span><span class="character">&quot;</span>, String.<span class="ST0">format</span>(
181                         <span class="ST2">FORMAT_MESSAGE_INSCRIPTION_SUCCES</span>,
182                         client.getPrenom(), client.getId()
183                 )
184         );
185 
186         JpaUtil.<span class="ST0">validerTransaction</span>();
187         JpaUtil.<span class="ST0">fermerEntityManager</span>();
188     }
189 
190     <span class="keyword-directive">public</span> Client <span class="ST1">authentifierClient</span>(String mail, String motDePasse) <span class="keyword-directive">throws</span> ServiceException {
191         JpaUtil.<span class="ST0">creerEntityManager</span>();
192         JpaUtil.<span class="ST0">ouvrirTransaction</span>();
193 
194         <span class="comment">// Trouver un client avec l&#39;adresse mail correspondante</span>
195         Client client = <span class="keyword-directive">null</span>;
196         <span class="keyword-directive">try</span> {
197             client = <span class="ST2">CLIENT_DAO</span>.findByMail(mail);
198         } <span class="keyword-directive">catch</span> (Throwable t) {
199             JpaUtil.<span class="ST0">fermerEntityManager</span>();
200             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_INTROUVABLE</span>);
201         }
202         JpaUtil.<span class="ST0">fermerEntityManager</span>();
203 
204         <span class="comment">// Vérifier le mot de passe.</span>
205         <span class="keyword-directive">if</span> (!motDePasse.equals(client.getMotDePasse())) {
206             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_MOT_DE_PASSE</span>);
207         }
208 
209         <span class="keyword-directive">return</span> client;
210     }
211 
212     <span class="keyword-directive">public</span> Cycliste <span class="ST1">authentifierCycliste</span>(String mail, String motDePasse) <span class="keyword-directive">throws</span> ServiceException {
213         JpaUtil.<span class="ST0">creerEntityManager</span>();
214         JpaUtil.<span class="ST0">ouvrirTransaction</span>();
215 
216         <span class="comment">// Trouver un client avec l&#39;adresse mail correspondante</span>
217         Cycliste cycliste = <span class="keyword-directive">null</span>;
218         <span class="keyword-directive">try</span> {
219             cycliste = (Cycliste) <span class="ST2">CYCLISTE_DAO</span>.findByMail(mail);
220         } <span class="keyword-directive">catch</span> (Throwable t) {
221             JpaUtil.<span class="ST0">fermerEntityManager</span>();
222             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_INTROUVABLE</span>);
223         }
224         JpaUtil.<span class="ST0">fermerEntityManager</span>();
225 
226         <span class="comment">// Vérifier le mot de passe.</span>
227         <span class="keyword-directive">if</span> (!motDePasse.equals(cycliste.getMotDePasse())) {
228             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_MOT_DE_PASSE</span>);
229         }
230 
231         <span class="keyword-directive">return</span> cycliste;
232     }
233 
234     <span class="keyword-directive">public</span> Gestionnaire <span class="ST1">authentifierGestionnaire</span>(String mail, String motDePasse) <span class="keyword-directive">throws</span> ServiceException {
235         JpaUtil.<span class="ST0">creerEntityManager</span>();
236         JpaUtil.<span class="ST0">ouvrirTransaction</span>();
237 
238         <span class="comment">// Trouver un client avec l&#39;adresse mail correspondante</span>
239         Gestionnaire gestionnaire = <span class="keyword-directive">null</span>;
240         <span class="keyword-directive">try</span> {
241             gestionnaire = <span class="ST2">GESTIONNAIRE_DAO</span>.findByMail(mail);
242         } <span class="keyword-directive">catch</span> (Throwable t) {
243             JpaUtil.<span class="ST0">fermerEntityManager</span>();
244             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_INTROUVABLE</span>);
245         }
246         JpaUtil.<span class="ST0">fermerEntityManager</span>();
247 
248         <span class="comment">// Vérifier le mot de passe.</span>
249         <span class="keyword-directive">if</span> (!motDePasse.equals(gestionnaire.getMotDePasse())) {
250             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_MOT_DE_PASSE</span>);
251         }
252 
253         <span class="keyword-directive">return</span> gestionnaire;
254     }
255 
256     <span class="keyword-directive">public</span> Livraison <span class="ST1">commander</span>(Client client, Restaurant restaurant, HashMap&lt;Produit, Long&gt; produits) <span class="keyword-directive">throws</span> ServiceException {
257         JpaUtil.<span class="ST0">creerEntityManager</span>();
258         Livraison livraison;
259         <span class="keyword-directive">do</span> {
260             JpaUtil.<span class="ST0">ouvrirTransaction</span>();
261 
262             <span class="comment">// Calcul des localisation</span>
263             <span class="keyword-directive">if</span> (client.getLatitude() == <span class="keyword-directive">null</span>) {
264                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
265                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_CLIENT_LATITUDE</span>);
266             }
267             <span class="keyword-directive">if</span> (client.getLongitude() == <span class="keyword-directive">null</span>) {
268                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
269                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_CLIENT_LONGITUDE</span>);
270             }
271             LatLng localisationClient = <span class="keyword-directive">new</span> LatLng(client.getLatitude(), client.getLongitude());
272 
273             <span class="keyword-directive">if</span> (restaurant.getLatitude() == <span class="keyword-directive">null</span>) {
274                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
275                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_RESTAURANT_LATITUDE</span>);
276             }
277             <span class="keyword-directive">if</span> (restaurant.getLongitude() == <span class="keyword-directive">null</span>) {
278                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
279                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_RESTAURANT_LONGITUDE</span>);
280             }
281             LatLng localisationRestaurant = <span class="keyword-directive">new</span> LatLng(restaurant.getLatitude(), restaurant.getLongitude());
282 
283             Double distanceRestaurantClient = ServiceTechnique.<span class="ST0">getFlightDistanceInKm</span>(localisationRestaurant, localisationClient);
284 
285             <span class="comment">// Calcul du poids de la commande</span>
286             Float poidsCommande = 0f;
287             <span class="keyword-directive">for</span> (<span class="ST0">Entry</span>&lt;Produit, Long&gt; entry : produits.entrySet()) {
288                 Produit produit = entry.getKey();
289                 poidsCommande += produit.getPoids() * entry.getValue();
290             }
291 
292             <span class="comment">// Liste des livreurs disponibles et capables de supporter la charge</span>
293             List&lt;Livreur&gt; listeLivreurs;
294             <span class="keyword-directive">try</span> {
295                 listeLivreurs = <span class="ST2">LIVREUR_DAO</span>.findAllAvalaibleWithCapacity(poidsCommande);
296             } <span class="keyword-directive">catch</span> (Throwable ex) {
297                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
298                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LIVREUR_LISTE</span>);
299             }
300 
301             <span class="comment">// Sélection du livreur le plus proche</span>
302             Livreur livreurSelection = <span class="keyword-directive">null</span>;
303             Double dureeMini = Double.<span class="ST2">MAX_VALUE</span>;
304             <span class="keyword-directive">for</span> (Livreur livreur : listeLivreurs) {
305                 Double duree = Double.<span class="ST2">MAX_VALUE</span>;
306                 <span class="keyword-directive">if</span> (livreur <span class="keyword-directive">instanceof</span> Cycliste) {
307                     duree = ServiceTechnique.<span class="ST0">getTripDurationByBicycleInMinute</span>(ServiceTechnique.<span class="ST0">getLatLng</span>(livreur.getAdresse()), localisationClient, localisationRestaurant);
308                 } <span class="keyword-directive">else</span> <span class="keyword-directive">if</span> (livreur <span class="keyword-directive">instanceof</span> Drone) {
309                     Double distance = ServiceTechnique.<span class="ST0">getFlightDistanceInKm</span>(ServiceTechnique.<span class="ST0">getLatLng</span>(livreur.getAdresse()), localisationRestaurant);
310                     distance += distanceRestaurantClient;
311                     duree = (distance / ((Drone) livreur).getVitesseMoyenne()) * 60;
312                 }
313                 <span class="keyword-directive">if</span> (dureeMini &gt; duree) {
314                     dureeMini = duree;
315                     livreurSelection = livreur;
316                 }
317             }
318 
319             <span class="keyword-directive">if</span> (livreurSelection == <span class="keyword-directive">null</span>) {
320                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
321                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LIVREUR_SELECTION</span>);
322             }
323 
324             <span class="comment">/* DEMO */</span>
325             System.<span class="ST2">out</span>.println(<span class="character">&quot;</span><span class="character">Attente de l&#39;utilisateur... Appuyer sur [Entrée] pour continuer.</span><span class="character">&quot;</span>);
326             <span class="keyword-directive">try</span> {
327                 System.<span class="ST2">in</span>.read();
328             } <span class="keyword-directive">catch</span> (Exception e) {
329             }
330             <span class="comment">/* --- */</span>
331 
332             livraison = <span class="keyword-directive">new</span> Livraison(client, livreurSelection, <span class="keyword-directive">new</span> Date(), <span class="keyword-directive">null</span>, produits);
333             <span class="keyword-directive">try</span> {
334                 <span class="ST2">LIVRAISON_DAO</span>.create(livraison);
335             } <span class="keyword-directive">catch</span> (Throwable ex) {
336                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
337                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LIVRAISON_CREATE</span>);
338             }
339 
340             livreurSelection.setDisponible(<span class="keyword-directive">false</span>);
341             <span class="keyword-directive">try</span> {
342                 <span class="ST2">LIVREUR_DAO</span>.update(livreurSelection);
343             } <span class="keyword-directive">catch</span> (Throwable ex) {
344                 JpaUtil.<span class="ST0">fermerEntityManager</span>();
345                 <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LIVREUR_UPDATE</span>);
346             }
347             <span class="keyword-directive">if</span> (livreurSelection <span class="keyword-directive">instanceof</span> Cycliste) {
348                 Cycliste cycliste = (Cycliste) livreurSelection;
349                 StringBuilder produitsCommande = <span class="keyword-directive">new</span> StringBuilder();
350                 Float total = 0.0f;
351                 <span class="keyword-directive">for</span> (<span class="ST0">Entry</span>&lt;Produit, Long&gt; e : produits.entrySet()) {
352                     Produit p = e.getKey();
353                     produitsCommande.append(String.<span class="ST0">format</span>(
354                             <span class="ST2">FORMAT_PRODUIT</span>, e.getValue(), p.getDenomination(),
355                             e.getValue(), p.getPrix()
356                     ));
357                     total += p.getPrix() * e.getValue();
358                 }
359 
360                 String corps = String.<span class="ST0">format</span>(
361                         <span class="ST2">FORMAT_MESSAGE_LIVREUR</span>, cycliste.getPrenom(),
362                         livraison.getDateCommande(), cycliste.getPrenom(),
363                         cycliste.getNom(), cycliste.getId(),
364                         restaurant.getDenomination(), client.getPrenom(),
365                         client.getNom(), client.getAdresse(), produitsCommande,
366                         total
367                 );
368                 ServiceTechnique.<span class="ST0">envoyerMail</span>(
369                         <span class="character">&quot;</span><span class="character">gustatif@gustatif.fr</span><span class="character">&quot;</span>, cycliste.getMail(),
370                         <span class="character">&quot;</span><span class="character">Livraison n°</span><span class="character">&quot;</span> + livraison.getId() + <span class="character">&quot;</span><span class="character"> à effectuer</span><span class="character">&quot;</span>, corps
371                 );
372             }
373 
374 
375             <span class="keyword-directive">try</span> {
376                 JpaUtil.<span class="ST0">validerTransaction</span>();
377                 <span class="keyword-directive">break</span>;
378             } <span class="keyword-directive">catch</span>(Exception e) { }
379         } <span class="keyword-directive">while</span> (<span class="keyword-directive">true</span>);
380         JpaUtil.<span class="ST0">fermerEntityManager</span>();
381         <span class="keyword-directive">return</span> livraison;
382     }
383 
384     <span class="keyword-directive">public</span> List&lt;Restaurant&gt; <span class="ST1">listerRestaurants</span>() <span class="keyword-directive">throws</span> ServiceException {
385         JpaUtil.<span class="ST0">creerEntityManager</span>();
386 
387         List&lt;Restaurant&gt; listeRestaurants;
388         <span class="keyword-directive">try</span> {
389             listeRestaurants = <span class="ST2">RESTAURANT_DAO</span>.findAll();
390         } <span class="keyword-directive">catch</span> (Throwable t) {
391             JpaUtil.<span class="ST0">fermerEntityManager</span>();
392             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LISTE_RESTAURANTS</span>);
393         }
394 
395         JpaUtil.<span class="ST0">fermerEntityManager</span>();
396         <span class="keyword-directive">return</span> listeRestaurants;
397     }
398 
399     <span class="keyword-directive">public</span> List&lt;Produit&gt; <span class="ST1">listerProduitsRestaurant</span>(Restaurant restaurant) {
400         JpaUtil.<span class="ST0">creerEntityManager</span>();
401 
402         List&lt;Produit&gt; listeProduits = restaurant.getProduits();
403 
404         JpaUtil.<span class="ST0">fermerEntityManager</span>();
405         <span class="keyword-directive">return</span> listeProduits;
406     }
407 
408     <span class="keyword-directive">public</span> List&lt;Livreur&gt; <span class="ST1">listerLivreurs</span>() <span class="keyword-directive">throws</span> ServiceException {
409         JpaUtil.<span class="ST0">creerEntityManager</span>();
410 
411         List&lt;Livreur&gt; listeLivreurs;
412         <span class="keyword-directive">try</span> {
413             listeLivreurs = <span class="ST2">LIVREUR_DAO</span>.findAll();
414         } <span class="keyword-directive">catch</span> (Throwable t) {
415             JpaUtil.<span class="ST0">fermerEntityManager</span>();
416             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LISTE_LIVREURS</span>);
417         }
418 
419         JpaUtil.<span class="ST0">fermerEntityManager</span>();
420         <span class="keyword-directive">return</span> listeLivreurs;
421     }
422 
423     <span class="keyword-directive">public</span> <span class="keyword-directive">void</span> <span class="ST1">cloturerLivraison</span>(Livraison livraison, Date dateLivraison) <span class="keyword-directive">throws</span> ServiceException {
424         JpaUtil.<span class="ST0">creerEntityManager</span>();
425         JpaUtil.<span class="ST0">ouvrirTransaction</span>();
426 
427         <span class="keyword-directive">if</span> (dateLivraison.before(livraison.getDateCommande())) {
428             JpaUtil.<span class="ST0">fermerEntityManager</span>();
429             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LIVRAISON_DATE</span>);
430         }
431         livraison.setDateLivraison(dateLivraison);
432         Livreur livreur = livraison.getLivreur();
433         livreur.setDisponible(<span class="keyword-directive">true</span>);
434         <span class="keyword-directive">try</span> {
435             <span class="ST2">LIVRAISON_DAO</span>.update(livraison);
436         } <span class="keyword-directive">catch</span> (Throwable ex) {
437             JpaUtil.<span class="ST0">fermerEntityManager</span>();
438             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LIVRAISON_UPDATE</span>);
439         }
440         <span class="keyword-directive">try</span> {
441             <span class="ST2">LIVREUR_DAO</span>.update(livreur);
442         } <span class="keyword-directive">catch</span> (Throwable ex) {
443             JpaUtil.<span class="ST0">fermerEntityManager</span>();
444             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_LIVREUR_UPDATE</span>);
445         }
446 
447         JpaUtil.<span class="ST0">validerTransaction</span>();
448         JpaUtil.<span class="ST0">fermerEntityManager</span>();
449     }
450 
451     <span class="keyword-directive">public</span> Livreur <span class="ST1">trouverLivreur</span>(Long id) <span class="keyword-directive">throws</span> ServiceException {
452         JpaUtil.<span class="ST0">creerEntityManager</span>();
453 
454         Livreur livreur = <span class="keyword-directive">null</span>;
455         <span class="keyword-directive">try</span> {
456             livreur = <span class="ST2">LIVREUR_DAO</span>.findById(id);
457         } <span class="keyword-directive">catch</span> (Throwable t) {
458             JpaUtil.<span class="ST0">fermerEntityManager</span>();
459             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_TROUVER_LIVREUR</span>);
460         }
461 
462         JpaUtil.<span class="ST0">fermerEntityManager</span>();
463         <span class="keyword-directive">return</span> livreur;
464     }
465 
466     <span class="keyword-directive">public</span> Livraison <span class="ST1">trouverLivraison</span>(Long id) <span class="keyword-directive">throws</span> ServiceException {
467         JpaUtil.<span class="ST0">creerEntityManager</span>();
468 
469         Livraison livraison = <span class="keyword-directive">null</span>;
470         <span class="keyword-directive">try</span> {
471             livraison = <span class="ST2">LIVRAISON_DAO</span>.findById(id);
472         } <span class="keyword-directive">catch</span> (Throwable t) {
473             JpaUtil.<span class="ST0">fermerEntityManager</span>();
474             <span class="keyword-directive">throw</span> <span class="keyword-directive">new</span> ServiceException(ServiceException.<span class="ST2">ERREUR_TROUVER_LIVRAISON</span>);
475         }
476 
477         JpaUtil.<span class="ST0">fermerEntityManager</span>();
478         <span class="keyword-directive">return</span> livraison;
479     }
480 
481 }
482 
</pre></body>
</html>
